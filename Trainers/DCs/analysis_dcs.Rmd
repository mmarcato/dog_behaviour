---
title: "Student Ethogram - Data Analysis"
author: "Marinara Marcato"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("ggpubr")
library(DescTools)
library(ggplot2)
library(dplyr)
library(plyr)

# not sure if necessary
library(tidyverse)
library(rstatix)
library(ggpubr)
```

## Introduction 
This document shows the data analysis carried out to investigate 
dog's behavioral data considering the ethograms filled out by students
Hazel and Conghal.


## Data Exploration

### Columns: Variables
The ethogram comprised of the following types and number of variables.

```{r, echo = FALSE}
setwd("C://Users//marinara.marcato//Data//Ethogram//Researchers")
data <- read.csv('20-05-20_Ethogram.csv')
vars <- read.csv('variables.csv')

# Adding a column to df vars for Test 
vars = vars %>% mutate(Test = case_when(
        Type == "count" ~ "Wilcoxon",
        Type == "ordinal" ~ "Wilcoxon", 
        Type == "categorical" ~ "Chisq"))

# print the number of variables per data type
print(table(vars$Type))
```

### Rows: Dogs
Total number of ethograms in the dataset, there is two per dog:
```{r data,  echo = FALSE}
# removing duplicates, 105 examples left
data = data[!duplicated(data[,3:4]),]
# data collection number per dog
dog_dc = aggregate(data$Data.Collection.Number, by = list(Category = data$Name), FUN = sum)
# retrieving name of dogs with dc1 and dc2
dogs_dcs = dog_dc[dog_dc$x ==3, 'Category']
# selecting dogs with dc1 and dc2 only
dcs = data %>% filter( Name %in% dogs_dcs)
# ordering the df by Name and DC
dcs = dcs[order(dcs$Name, dcs$Data.Collection.Number),]
dcs$Name = factor(dcs$Name)
cat("Number of dogs with DC1 and DC2: ", length(unique(dcs$Name)))
```


## Within Subject Analysis

result = wilcox.test(dcs[dcs$Data.Collection.Number == 1 , "Isolation.Response..Time.oriented."],  dcs[dcs$Data.Collection.Number == 2, "Isolation.Response..Time.oriented."], paired = TRUE)
class(result[["statistic"]])
, 
```{r, include = TRUE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
## SUMMARY STATISTICS

for (var in na.omit(vars[vars$Test == "Wilcoxon", "Variable"])){
  print(var)
  print(aggregate(var ~ Data.Collection.Number, data = dcs, summary))
}    


for (var in na.omit(vars[vars$Test == "Wilcoxon", "Variable"])){
  print(str(var))
  print(wilcox.test(dcs[dcs$Data.Collection.Number == 1 , var],  dcs[dcs$Data.Collection.Number == 2, var], paired = TRUE)[1:3])
}


wilcox <- function(var){
  print(var)
  wilcox.test(dcs[dcs$Data.Collection.Number == 1 , var],  dcs[dcs$Data.Collection.Number == 2, var], paired = TRUE)
}
tests <- function(test, var){
  if (!is.na(test)){
    if (test == 'Wilcoxon'){
        r = wilcox.test(dcs[dcs$Data.Collection.Number == 1 , as.character(var)],  dcs[dcs$Data.Collection.Number == 2, as.character(var)], paired = TRUE)
        return (r[1])
        #return(list(r$statistic, r$p.value))
    } else if (test == 'Chisq'){
      dc1 = dcs[dcs$Data.Collection.Number == 1 , as.character(var)]
      dc2 = dcs[dcs$Data.Collection.Number == 2, as.character(var)]
      cat(dc1,"\n", dc2,"\n")
      cat(unique(dc1),"\n", unique(dc2),"\n")
      if ((unique(dc1) == unique(dc2)) & (length(unique(dc1))>1) & (length(unique(dc2))>1)){
        r = chisq.test(dc1, dc2)
        return(r[1])
        #return(list(r$statistic, r$p.value))
      }
    }
    return(NA)
    #return(list(NA, NA))
  }
  return(NA)
}

dcs %>% mutate(Result = mapply(FUN = tests, test = vars$Test, var = vars$Variable))

dc1 = dcs[dcs$Data.Collection.Number == 1 , "Tea.Towel.First.Response..Indifferent."]
dc2 = dcs[dcs$Data.Collection.Number == 2, "Tea.Towel.First.Response..Indifferent."]
r =chisq.test(dc1, dc2)

length(df)
lt = mapply(FUN = stats, test = vars$Test, var = vars$Variable)
df = as.data.frame(unlist(lt))
colnames(df)
df1 = as.data.frame(t(as.data.frame(lt)))
df2 = as.data.frame(matrix(unlist(lt), nrow = length(lt)))
name = names(df)


```
### Ordinal data
Running Wilcoxon for ordinal data. 
```{r, include = TRUE}
# groups are the dcs
ordinal_within_groups <- function(df){
  result = c()
  for (variable in ordinal){
      r = wilcox.test(df[df$Data.Collection.Number == 1 , variable], df[df$Data.Collection.Number == 2, variable], paired = TRUE)
      result = rbind(result, c(variable, r[1], r[2], r[3]))
  }
  return (result)
}

dcs_ordinal = ordinal_within_groups(dcs)
ordinal_sign = dcs_ordinal[dcs_ordinal[,4]<0.05, ]
print(ordinal_sign)
```

### Count data
Running wilcoxon for count data. No signficant results found.
```{r, include = TRUE}
# groups are the dcs
count_within_groups <- function(df){
  result = c()
  for (variable in count){
      r = wilcox.test(df[df$Data.Collection.Number == 1 , variable], df[df$Data.Collection.Number == 2, variable], paired = TRUE)
      result = rbind(result, c(variable, r[1], r[2], r[3]))
  }
  return (result)
}
dcs_count = count_within_groups(dcs)
count_sign = dcs_count[dcs_count[,4]<0.05, ]
```

### Categorical data
run chi-squared for categorical data

```{r, include = TRUE}
# groups are the dcs
categorical_within_groups <- function(df){
  result = c()
  for (variable in categorical){
    if (length(unique(df[df$Data.Collection.Number == 1 ,variable]))>1 & length(unique(df[df$Data.Collection.Number == 2 ,variable]))>1){
      #`correct=FALSE` to turn off Yatesâ€™ continuity correction.? 
      r = chisq.test(df[df$Data.Collection.Number == 1 , variable], df[df$Data.Collection.Number == 2, variable])
      result = rbind(result, c(variable, r[1], r[2], r[3]))
    }
  }
  return (result)
}
dcs_categorical = categorical_within_groups(dcs)
categorical_sign = dcs_categorical[dcs_categorical[,4]<0.05, ]
print(unlist(categorical_sign[,1]))
```
