---
title: "Trainers Ethogram - Outcome (Success, Fail) - Hypothesis Testing"
author: "Marinara Marcato"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/marinara.marcato/Project/Scripts/dog_ethogram")
knitr::opts_chunk$set(echo = TRUE)
#install.packages("ggpubr")
library(DescTools)
library(ggplot2)
library(dplyr)
library(plyr)
library(tidyverse)
library(rstatix)
library(ggpubr)
```

## Introduction 
This document shows the data analysis carried out to investigate 
dog's behavioral data considering the ethograms filled out by two trainers.

## Data Exploration
### Columns: Variables
The ethogram comprised of the following types and number of variables.

```{r, echo = FALSE}
dc1 <- read.csv('0_data//2_analysis//2021-06-08_Ethogram-Trainers-DC1.csv', 
          # prevents importing categories as factors datatype
          stringsAsFactors=FALSE, 
          # imports "" as NA
          na.strings=c(""))

dc2 <- read.csv('0_data//2_analysis//2021-06-08_Ethogram-Trainers-DC2.csv',
          # prevents importing categories as factors datatype
          stringsAsFactors=FALSE, 
          # imports "" as NA
          na.strings=c(""))

vars <- read.csv('0_data//0_raw//ethogram-variables-trainers.csv', stringsAsFactors=FALSE)
dc1 <- dc1 %>% mutate( Label = case_when( Status == 'AD' ~ "Success",
                                    Status == 'GD' ~ "Success",
                                    Status == 'W' ~ "Fail"))
dc2 <- dc2 %>% mutate( Label = case_when( Status == 'AD' ~ "Success",
                                    Status == 'GD' ~ "Success",
                                    Status == 'W' ~ "Fail"))

```


### Rows: Dogs
Total number of dogs with DC1 and DC2:
```{r, echo = FALSE}
## dogs with dc1
cat('Dogs with DC1: ', length(dc1$Name))
# removing dogs in Training
dc1_outcome = dc1 %>% filter( Status != 'in Training' )
# printing out information
cat("DC1 & Outcome:", length(dc1_outcome$Name), "\n", paste(sort(dc1_outcome$Name), collapse = ", "))

## dogs with dc2 
cat('Dogs with DC2: ', length(dc2$Name))
# removing dogs in Training
dc2_outcome = dc2 %>% filter( Status != 'in Training' )
# printing out information
cat("DC2 & Outcome:", length(dc2_outcome$Name), "\n", paste(sort(dc2_outcome$Name), collapse = ", "))

```

## Data Analysis
Hypothesis testing: investigate difference in behavioural scores for all variables analysed at (DC1, DC2) considering the training outcome ('Success', 'Fail'). 
The following statistical tests were performed considering the variable type  <br>
Kruskal -> Ordinal = 53 variables in total<br>
Chiqs -> Categorical = 17 variables in total<br>

- [Two-sample Mannâ€“Whitney U Test](https://rcompanion.org/handbook/F_04.html) For Independent Variable with two levels (two independent groups), aka wilcox.test in R
- [Kruskal Wallis](https://rcompanion.org/handbook/F_08.html) For Independent Variable with two or more levels (two independent groups)



```{r, echo = FALSE}
# print the number of variables per data type
print(table(vars$Type))

# Adding a column to df vars for Test 
vars = vars %>% mutate(Test = case_when(
        Type == "count" ~ "Wilcoxon",
        Type == "ordinal" ~ "Wilcoxon", 
        Type == "categorical" ~ "Chisq"))
print('Wilcoxon')
unique(vars[vars$Test == 'Wilcox', 'Variable'])
print('Chisq')
unique(vars[vars$Test == 'Chisq', 'Variable'])

```
```{r, include = FALSE}
stats <- function(test, var, data, group){
  print(var)
  if (!is.na(test)){
    if (test == 'Wilcoxon'){
      cat('Wilcoxon\n\n')
      r = wilcox.test(data[,var] ~ data[,group])
      return(r$p.value)
      return('Wilcoxon')
    }

    else if (test == 'Chisq'){  
      cat('Chisq\n\n', length(unique(data[,var])), length(unique(data[,group])))
        if ((n_distinct(data[,var], na.rm = TRUE)>1) & (n_distinct(data[,group], na.rm = TRUE)>1))
        {
          r = chisq.test(data[,var], data[,group], simulate.p.value=TRUE)
          return(r$p.value)
          return('Chisq')
        }
    }
    return(NA)
  }
  return(NA)
}

vars = vars %>% mutate(dc1_outcome = mapply(FUN = stats, test = vars$Test, 
          var = vars$Variable, MoreArgs = list(dc1_outcome, 'Label')))
vars = vars %>% mutate(dc2_outcome = mapply(FUN = stats, test = vars$Test,
           var = vars$Variable, MoreArgs = list(dc2_outcome, 'Label')))


```

## Results
Results are saved in a file (trainers_outcome.csv). Below are variable with statistically significant results. <br>
It means that dogs with different training outcomes ('Success', 'Fail')showed a statistically different behaviour taking DC1 at Week 3 and DC2 Week 10. 
```{r, echo = FALSE}
vars$dc1_sign = ifelse(vars$dc1_outcome<0.05, 1, 0)
vars$dc2_sign = ifelse(vars$dc2_outcome<0.05, 1, 0)
write.csv(vars, "0_data//3_results//trainers_outcome.csv")

print('DC1 significant results:')
unique(vars[vars$dc1_sign == 1, 'Variable'])
print('DC2 significant results:')
unique(vars[vars$dc2_sign == 1, 'Variable'])
```